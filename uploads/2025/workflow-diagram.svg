<svg viewBox="0 0 1400 1600" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .state { fill: #4A90E2; stroke: #2E5C8A; stroke-width: 2; }
      .state-error { fill: #E74C3C; stroke: #C0392B; stroke-width: 2; }
      .state-success { fill: #27AE60; stroke: #1E8449; stroke-width: 2; }
      .state-start { fill: #95A5A6; stroke: #7F8C8D; stroke-width: 2; }
      .state-design { fill: #9B59B6; stroke: #6C3483; stroke-width: 2; }
      .state-text { fill: white; font-family: Arial, sans-serif; font-size: 13px; font-weight: bold; text-anchor: middle; }
      .transition { fill: none; stroke: #34495E; stroke-width: 2; marker-end: url(#arrowhead); }
      .transition-error { fill: none; stroke: #E74C3C; stroke-width: 2; marker-end: url(#arrowhead-error); stroke-dasharray: 5,5; }
      .label { fill: #2C3E50; font-family: Arial, sans-serif; font-size: 11px; text-anchor: middle; }
      .gate-label { fill: #16A085; font-family: Arial, sans-serif; font-size: 10px; font-weight: bold; text-anchor: start; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495E" />
    </marker>
    <marker id="arrowhead-error" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#E74C3C" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="30" font-family="Arial, sans-serif" font-size="22" font-weight="bold" text-anchor="middle" fill="#2C3E50">
    Intent-Driven TDD Workflow with Infrastructure Gates
  </text>

  <!-- Phase Labels -->
  <text x="50" y="80" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#7F8C8D">DESIGN PHASE</text>
  <text x="50" y="640" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#7F8C8D">IMPLEMENTATION</text>
  <text x="50" y="1160" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#7F8C8D">VALIDATION</text>

  <!-- States - Design Phase -->
  
  <!-- 1. INTENT_DEFINED -->
  <rect x="550" y="60" width="300" height="50" rx="5" class="state-start"/>
  <text x="700" y="90" class="state-text">INTENT_DEFINED</text>

  <!-- 2. SPECIFICATION_COMPLETE -->
  <rect x="550" y="150" width="300" height="50" rx="5" class="state-design"/>
  <text x="700" y="180" class="state-text">SPECIFICATION_COMPLETE</text>

  <!-- 3. DOMAIN_INTERFACES_DEFINED -->
  <rect x="550" y="240" width="300" height="50" rx="5" class="state-design"/>
  <text x="700" y="270" class="state-text">DOMAIN_INTERFACES_DEFINED</text>

  <!-- 4. ACL_INTERFACES_DEFINED -->
  <rect x="550" y="330" width="300" height="50" rx="5" class="state-design"/>
  <text x="700" y="360" class="state-text">ACL_INTERFACES_DEFINED</text>

  <!-- 5. INFRASTRUCTURE_ABSTRACTIONS_DEFINED -->
  <rect x="550" y="420" width="300" height="50" rx="5" class="state-design"/>
  <text x="700" y="445" class="state-text">INFRA_ABSTRACTIONS_DEFINED</text>

  <!-- 6. DEPENDENCY_INJECTION_DESIGNED -->
  <rect x="550" y="510" width="300" height="50" rx="5" class="state-design"/>
  <text x="700" y="540" class="state-text">DI_DESIGNED</text>

  <!-- States - Implementation Phase -->
  
  <!-- 7. BDD_SCENARIOS_DEFINED -->
  <rect x="550" y="620" width="300" height="50" rx="5" class="state"/>
  <text x="700" y="650" class="state-text">BDD_SCENARIOS_DEFINED</text>

  <!-- 8. TESTS_FAILING -->
  <rect x="550" y="710" width="300" height="50" rx="5" class="state"/>
  <text x="700" y="740" class="state-text">TESTS_FAILING</text>

  <!-- 9. TESTS_PASSING -->
  <rect x="550" y="800" width="300" height="50" rx="5" class="state"/>
  <text x="700" y="830" class="state-text">TESTS_PASSING</text>

  <!-- 10. QUALITY_GATES_PASSING -->
  <rect x="550" y="890" width="300" height="50" rx="5" class="state"/>
  <text x="700" y="915" class="state-text">QUALITY_GATES_PASSING</text>
  <text x="700" y="930" class="state-text" font-size="10">(pytest/mypy/black/ruff)</text>

  <!-- States - Validation Phase -->
  
  <!-- 11. INFRASTRUCTURE_VALIDATED -->
  <rect x="300" y="1010" width="250" height="50" rx="5" class="state"/>
  <text x="425" y="1040" class="state-text">INFRA_VALIDATED</text>

  <!-- 11-error. INFRASTRUCTURE_FAILED -->
  <rect x="850" y="1010" width="250" height="50" rx="5" class="state-error"/>
  <text x="975" y="1040" class="state-text">INFRA_FAILED</text>

  <!-- 12. ARCHITECTURE_ALIGNED -->
  <rect x="300" y="1130" width="250" height="50" rx="5" class="state"/>
  <text x="425" y="1160" class="state-text">ARCHITECTURE_ALIGNED</text>

  <!-- 12-error. ARCHITECTURE_MISALIGNED -->
  <rect x="850" y="1130" width="250" height="50" rx="5" class="state-error"/>
  <text x="975" y="1160" class="state-text">ARCHITECTURE_MISALIGNED</text>

  <!-- 13. READY_TO_MERGE -->
  <rect x="300" y="1250" width="250" height="50" rx="5" class="state-success"/>
  <text x="425" y="1280" class="state-text">READY_TO_MERGE</text>

  <!-- Transitions - Design Phase -->
  
  <!-- INTENT → SPECIFICATION -->
  <path d="M 700 110 L 700 150" class="transition"/>
  <text x="750" y="135" class="gate-label">Gate 1: Spec Exists</text>

  <!-- SPECIFICATION → DOMAIN_INTERFACES -->
  <path d="M 700 200 L 700 240" class="transition"/>
  <text x="750" y="225" class="gate-label">Gate 2: Pure Domain</text>

  <!-- DOMAIN_INTERFACES → ACL_INTERFACES -->
  <path d="M 700 290 L 700 330" class="transition"/>
  <text x="750" y="315" class="gate-label">Gate 3: ACL Defined</text>

  <!-- ACL_INTERFACES → INFRASTRUCTURE_ABSTRACTIONS -->
  <path d="M 700 380 L 700 420" class="transition"/>
  <text x="750" y="405" class="gate-label">Gate 4: Infra Design</text>

  <!-- INFRASTRUCTURE_ABSTRACTIONS → DEPENDENCY_INJECTION -->
  <path d="M 700 470 L 700 510" class="transition"/>
  <text x="750" y="495" class="gate-label">Gate 5: DI Config</text>

  <!-- Transitions - Implementation Phase -->
  
  <!-- DI_DESIGNED → BDD_SCENARIOS -->
  <path d="M 700 560 L 700 620" class="transition"/>
  <text x="750" y="595" class="gate-label">Gate 6: BDD Written</text>

  <!-- BDD_SCENARIOS → TESTS_FAILING -->
  <path d="M 700 670 L 700 710" class="transition"/>
  <text x="750" y="695" class="gate-label">Gate 7: Tests Exist</text>

  <!-- TESTS_FAILING → TESTS_PASSING -->
  <path d="M 700 760 L 700 800" class="transition"/>
  <text x="750" y="785" class="gate-label">Gate 8: Implement</text>

  <!-- TESTS_PASSING → QUALITY_GATES -->
  <path d="M 700 850 L 700 890" class="transition"/>
  <text x="750" y="875" class="gate-label">Gate 9: Quality</text>

  <!-- Transitions - Validation Phase -->
  
  <!-- QUALITY_GATES → INFRASTRUCTURE_VALIDATED -->
  <path d="M 650 940 L 475 1010" class="transition"/>
  <text x="520" y="970" class="gate-label">Gate 10: Infra Check</text>

  <!-- QUALITY_GATES → INFRASTRUCTURE_FAILED -->
  <path d="M 750 940 L 925 1010" class="transition"/>
  <text x="800" y="970" class="label" fill="#E74C3C">Infra violations</text>

  <!-- INFRASTRUCTURE_FAILED → TESTS_PASSING (loop) -->
  <path d="M 975 1010 Q 1150 850 850 825" class="transition-error"/>
  <text x="1000" y="900" class="label" fill="#E74C3C">Fix: DI/ACL/naming</text>

  <!-- INFRASTRUCTURE_VALIDATED → ARCHITECTURE_ALIGNED -->
  <path d="M 425 1060 L 425 1130" class="transition"/>
  <text x="480" y="1100" class="gate-label">Gate 11: Doc Match</text>

  <!-- INFRASTRUCTURE_VALIDATED → ARCHITECTURE_MISALIGNED -->
  <path d="M 550 1035 L 850 1155" class="transition"/>
  <text x="690" y="1090" class="label" fill="#E74C3C">Code ≠ docs</text>

  <!-- ARCHITECTURE_MISALIGNED → TESTS_PASSING (loop) -->
  <path d="M 850 1155 Q 750 1000 700 850" class="transition-error"/>
  <text x="680" y="1000" class="label" fill="#E74C3C">Refactor to match docs</text>

  <!-- ARCHITECTURE_ALIGNED → READY_TO_MERGE -->
  <path d="M 425 1180 L 425 1250" class="transition"/>
  <text x="480" y="1220" class="gate-label">Gate 12: Final Check</text>

  <!-- Critical Gates Callout -->
  <rect x="950" y="420" width="400" height="180" rx="5" fill="#FEF5E7" stroke="#F39C12" stroke-width="2"/>
  <text x="1150" y="445" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#D68910">
    CRITICAL INFRASTRUCTURE GATES
  </text>
  <text x="965" y="470" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">
    <tspan x="965" dy="0">Gate 4: Prevents OutputParserFactory</tspan>
    <tspan x="965" dy="18">         creating clients (naming mismatch)</tspan>
    <tspan x="965" dy="20">Gate 5: Prevents Container injecting</tspan>
    <tspan x="965" dy="18">         concrete OpenRouterClient</tspan>
    <tspan x="965" dy="20">Gate 10: Catches hard-coded providers,</tspan>
    <tspan x="965" dy="18">          magic strings, DI violations</tspan>
  </text>

  <!-- Phase 6 Failure Example -->
  <rect x="950" y="630" width="400" height="120" rx="5" fill="#FADBD8" stroke="#E74C3C" stroke-width="2"/>
  <text x="1150" y="655" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#C0392B">
    PHASE 6 FAILURES (Prevented by Gates)
  </text>
  <text x="965" y="680" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">
    <tspan x="965" dy="0">❌ Skipped Gate 4 → Wrong abstraction</tspan>
    <tspan x="965" dy="18">❌ Skipped Gate 5 → Concrete injection</tspan>
    <tspan x="965" dy="18">❌ Skipped Gate 10 → DI/ACL violations</tspan>
    <tspan x="965" dy="18">Result: 3 phases to fix (P6, P7, P7b)</tspan>
  </text>

  <!-- Legend -->
  <g transform="translate(950, 790)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#2C3E50">Legend</text>
    
    <rect x="0" y="10" width="60" height="25" rx="3" class="state-start"/>
    <text x="70" y="27" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Start</text>
    
    <rect x="0" y="45" width="60" height="25" rx="3" class="state-design"/>
    <text x="70" y="62" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Design Phase</text>
    
    <rect x="0" y="80" width="60" height="25" rx="3" class="state"/>
    <text x="70" y="97" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Implementation</text>
    
    <rect x="200" y="10" width="60" height="25" rx="3" class="state-error"/>
    <text x="270" y="27" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Error State</text>
    
    <rect x="200" y="45" width="60" height="25" rx="3" class="state-success"/>
    <text x="270" y="62" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Success</text>
    
    <line x1="200" y1="90" x2="250" y2="90" class="transition"/>
    <text x="260" y="95" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Forward</text>
    
    <line x1="200" y1="110" x2="250" y2="110" class="transition-error"/>
    <text x="260" y="115" font-family="Arial, sans-serif" font-size="11" fill="#2C3E50">Error Loop</text>
  </g>

  <!-- Key Insight -->
  <rect x="50" y="1350" width="1300" height="80" rx="5" fill="#E8F8F5" stroke="#16A085" stroke-width="2"/>
  <text x="700" y="1375" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#0E6655">
    KEY INSIGHT: Gates 4, 5, and 10 Enforce Infrastructure Quality
  </text>
  <text x="700" y="1400" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#2C3E50">
    Without explicit infrastructure gates, agents optimize for passing tests (irrational metric) rather than architectural quality.
  </text>
  <text x="700" y="1418" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#2C3E50">
    These gates make Performance Measures explicit and knowable, enabling rational agent behavior within the PEAS framework.
  </text>

  <!-- Automation Note -->
  <text x="50" y="1480" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#7F8C8D">
    Automation Strategy:
  </text>
  <text x="50" y="1502" font-family="Arial, sans-serif" font-size="10" fill="#2C3E50">
    • Gates 1-6: Manual review (design decisions)
  </text>
  <text x="50" y="1518" font-family="Arial, sans-serif" font-size="10" fill="#2C3E50">
    • Gates 7-9: Automated (test execution, quality tools)
  </text>
  <text x="50" y="1534" font-family="Arial, sans-serif" font-size="10" fill="#2C3E50">
    • Gates 10-11: Automated (static analysis, architecture compliance)
  </text>
  <text x="50" y="1550" font-family="Arial, sans-serif" font-size="10" fill="#2C3E50">
    • Gate 12: Semi-automated (aggregate validation + human approval)
  </text>
</svg>